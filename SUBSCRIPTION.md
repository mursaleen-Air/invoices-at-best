# Subscription System Documentation

This document outlines the subscription system implementation for InvoiceGen.

## Overview

The subscription system allows users to upgrade to a "Premium" tier to remove watermarks from generated PDF documents.

## Components

1.  **Database**:
    *   Table: `public.subscriptions`
    *   Relationships: `user_id` references `auth.users(id)`
    *   RLS Policies: Users can read/insert/update only their own subscription rows.

2.  **Backend Logic (`src/lib/subscription.ts`)**:
    *   `getUserSubscription(userId)`: Fetches current subscription status.
    *   `activateSubscription(userId)`: Activates premium status (sets tier to 'premium', status to 'active').
    *   `cancelSubscription(userId)`: Cancels subscription (sets status to 'canceled').
    *   `isPremiumUser(userId)`: Helper to check if user has active premium subscription.

3.  **API Routes**:
    *   `GET /api/subscription/status`: Returns `{ isPremium: boolean, tier: string, status: string, ... }`.
    *   `POST /api/subscription/activate`: Upgrades the authenticated user to premium.
    *   `POST /api/subscription/cancel`: Downgrades the authenticated user.

4.  **Frontend**:
    *   **Pricing Page**: Checks auth/subscription status. "Upgrade" button calls API to activate. Redirects to login if needed.
    *   **Dashboard**: Shows a `SubscriptionCard` with current status and management options (Cancel).
    *   **Header**: Displays a "PRO" badge for premium users.
    *   **PDF Generator**: Checks `isPremium` flag. If true, removes watermark and "Generated by InvoiceGen" branding.

## How to Test

1.  **Sign Up / Login**: Create a new account or log in.
2.  **Check Status**: Go to Dashboard. You should see "Free Plan".
3.  **Upgrade**: Go to `/pricing` and click "Upgrade to Premium".
    *   The system will process the "payment" (mock) and update your status.
    *   You will be redirected to Dashboard with "Premium Plan" active.
4.  **Verify**: Generate a PDF invoice. It should NOT have a watermark.
5.  **Cancel**: In Dashboard, click "Cancel Subscription". Status reverts to Free (effectively).

## Troubleshooting

-   **"Subscription table not found"**: Ensure you ran the migration file `supabase/migrations/001_create_subscriptions.sql` in your Supabase SQL Editor.
-   **"RLS Policy violation"**: Check that RLS policies on `subscriptions` table allow users to INSERT/UPDATE their own rows.
-   **"Not upgrading"**: Check browser console for API errors. Ensure you are logged in.

## Future Improvements

-   Integrate real payment gateway (Stripe/LemonSqueezy) in `activateSubscription`.
-   Implement webhooks to handle subscription events (renewals, cancellations).
-   Add email notifications.
